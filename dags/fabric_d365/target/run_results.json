{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.8.2", "generated_at": "2024-08-26T09:17:56.259512Z", "invocation_id": "f82bf10a-1a55-4257-84d6-c7877206e9f3", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2024-08-26T09:17:25.263802Z", "completed_at": "2024-08-26T09:17:25.274807Z"}, {"name": "execute", "started_at": "2024-08-26T09:17:25.275809Z", "completed_at": "2024-08-26T09:17:56.245513Z"}], "thread_id": "Thread-3 (worker)", "execution_time": 30.98680067062378, "adapter_response": {"_message": "OK", "rows_affected": 72636}, "message": "OK", "failures": null, "unique_id": "model.d365.stg_dim_d365_workflowapproval_1", "compiled": true, "compiled_code": "\n\n/* Not intended to be an actual dimension table, required for Facts PurchaseOrderLine, PurchaseRequisitionLine & VendPackingSlipLine */\n\nwith ct as (\n    select\n        \n    lower(convert(varchar(50), hashbytes('md5', coalesce(convert(varchar(8000), concat(coalesce(cast(wtst.recid as VARCHAR(8000)), '_dbt_utils_surrogate_key_null_'), '-', coalesce(cast(wtt.recid as VARCHAR(8000)), '_dbt_utils_surrogate_key_null_'))), '')), 2))\n as dim_d365_workflowapproval_sk\n        -- { { d b t _ utils.generate_surrogate_key(['wtst.recid', 'wtt.recid', 'pprwt.mserp_recid', 'pprwl.recid'])}} as dim_d365_workflowapproval_sk\n        , wtst.instancenumber\n        /* use to join to Customer, vendor, bank acct if required\n            contexttableid = 67286 links to cutom dxc table for Purch line & purch req line */\n        , wtst.contexttableid\n        , wtst.contextrecid\n        , wtst.document\n        , wtst.documenttype\n        , wtst.originator\n        , cast(nullif(json_value(ewtt.enumtranslation, CONCAT('$.trackingtype.\"', wtt.trackingtype,'\"')), '') as varchar(2048)) as trackingtype\n        , cast(nullif(json_value(ewtc.enumtranslation, CONCAT('$.trackingcontext.\"', wtt.trackingcontext,'\"')), '') as varchar(2048)) as trackingcontext\n        , case when wtt.[user] = 'D365BatchUser' then 'D365BatchUser' else p.name end as approver\n        /* Admin or Batch user can have approval record after actual user - prioritise actual user\n            multiple instancenumbers can exist per contextrecid when not linked to ods_d365_dxc_purchpurchreqworkflowtable\n            when this stg dim is used to join on contexttableid & contextrecid ensure that approval_context_rnk =1 in join clause\n        */\n        , rank() over (\n            partition by wtst.instancenumber, wtst.contextrecid\n            order by\n                case when wtt.[user] in ('D365BatchUser', 'Admin') then 1 else 0 end\n                , wtt.createddatetime desc\n        ) as approval_rnk\n        , rank() over (\n            partition by wtst.contexttableid, wtst.contextrecid\n            order by\n                case when wtt.[user] in ('D365BatchUser', 'Admin') then 1 else 0 end\n                , wtt.createddatetime desc\n        ) as approval_context_rnk\n\n        , apdnz.newzealandtime as approvaldatetime_nzt\n        --    , pprwt.mserp_documentnum\n        , null as documentnum\n        --    , pprwt.mserp_submitter\n        , null as submitter\n        --    , pprwt.mserp_createdby\n        , null as createdby\n        --    , pprwt.mserp_costcentreowner\n        , null as costcentreowner\n        --    , pprwt.mserp_costcentrevalue\n        , null as costcentrevalue\n        --    , pprwt.mserp_costcentrename\n        , null as costcentrename\n        --    , round(pprwt.mserp_costcentreownerapprovalamount, 2) as costcentreownerapprovalamount\n        , null as costcentreownerapprovalamount\n        --    , pprwt.mserp_budgetcontrol\n        , null as budgetcontrol\n        --    , eppws.[LocalizedLabel] as workflowstatus\n        , null as workflowstatus\n        --    , eppwls.[LocalizedLabel] as workflowstatus_line\n        , null as workflowstatus_line\n\n        --    , po.purchid\n        , null as purchid\n        --    , po.recid as purch_recid\n        , null as purch_recid\n        --    , pol.recid as purchline_recid\n        , null as purchline_recid\n        --    , pr.purchreqid\n        , null as purchreqid\n        --    , pr.recid as purchreq_recid\n        , null as purchreq_recid\n        --    , prl.recid as purchreqline_recid\n        , null as purchreqline_recid\n\n        , upper(wtst.contextcompanyid) as dataareaid\n\n    from \"dataverse_sanfordsit_devpremsanpowerplatfstor_unqf87dd056b3bf4075bf970702376af\".\"dbo\".\"workflowtrackingstatustable\" as wtst\n    left join \"dataverse_sanfordsit_devpremsanpowerplatfstor_unqf87dd056b3bf4075bf970702376af\".\"dbo\".\"workflowtrackingtable\" as wtt on wtst.recid = wtt.workflowtrackingstatustable\n\n    cross apply stage.f_get_enum_translation('workflowtrackingtable', '1033') as ewtt\n    cross apply stage.f_get_enum_translation('workflowtrackingtable', '1033') as ewtc\n    /*\n    left join { {s o u rce('mserp', 'dxc_purchpurchreqworkflowtable')}} pprwt on wtst.contexttableid = 67286\n        and wtst.contextrecid = pprwt.mserp_recid\n\n    left join { {s o u rce('fno', 'GlobalOp  tionsetM etadata') }} as eppws on eppws.[EntityName] = 'dxc_purchpurchreqworkflowtable'\n        and eppws.[OptionSetName] = 'mserp_workflowstatus'\n        and pprwt.mserp_workflowstatus = eppws.[Option]\n\n    / * TableID 19571 = PurchReq, 19637 = PurchOrder * /\n    left join { { s o u rce('fno', 'purchtable')}} po on pprwt.mserp_reftableid = 19637\n        and pprwt.mserp_refrecid = po.recid\n    left join { { s o u rce('fno', 'purchreqtable')}} pr on pprwt.mserp_reftableid = 19571\n        and pprwt.mserp_refrecid = pr.recid\n\n    / * PO / PR Lines can be approved by different people in same PO / PR * /\n    left join { { s o u rce('fno', 'dxc_purchpurchreqworkflowline')}} pprwl on pprwt.mserp_recid = pprwl.purchpurchreqworkflowtablerecid\n\n    left join { { s o u rce('fno', 'GlobalOptio nsetMe tadata') }} as eppwls on eppwls.[EntityName] = 'dxc_purchpurchreqworkflowline'\n        and eppwls.[OptionSetName] = 'mserp_workflowstatus'\n        and pprwl.workflowstatus = eppwls.[Option]\n\n    / * TableID 6354 = PurchLine, 4574 = PurchReqLine * /\n    left join { { s o u rce('fno', 'purchline')}} pol on pprwl.reftableid = 6354\n        and pprwl.refrecid = pol.recid\n\n    left join { { s o u rce('fno', 'purchreqline')}} prl on pprwl.reftableid = 4574\n        and pprwl.refrecid = prl.recid\n    */\n    left join \"dataverse_sanfordsit_devpremsanpowerplatfstor_unqf87dd056b3bf4075bf970702376af\".\"dbo\".\"dirpersonuser\" as u on wtt.[user] = u.[user]\n    left join \"dwh_sanford\".\"dw\".\"dim_d365_party\" as p on u.personparty = p.party_recid\n    cross apply dbo.f_convert_utc_to_nzt(wtt.createddatetime) as apdnz\n    where\n        (\n            /* auto Admin approval */\n            (cast(nullif(json_value(ewtt.enumtranslation, CONCAT('$.trackingtype.\"', wtt.trackingtype,'\"')), '') as varchar(2048)) = 'Completion' and cast(nullif(json_value(ewtc.enumtranslation, CONCAT('$.trackingcontext.\"', wtt.trackingcontext,'\"')), '') as varchar(2048)) = 'Approval')\n            or\n            /* user approved */\n            (cast(nullif(json_value(ewtt.enumtranslation, CONCAT('$.trackingtype.\"', wtt.trackingtype,'\"')), '') as varchar(2048)) = 'Approval' and cast(nullif(json_value(ewtc.enumtranslation, CONCAT('$.trackingcontext.\"', wtt.trackingcontext,'\"')), '') as varchar(2048)) = 'Work item')\n        )\n)\n\nselect\n    dim_d365_workflowapproval_sk\n    , instancenumber\n    , contexttableid\n    , contextrecid\n    , document\n    , documenttype\n    , originator\n    , trackingtype\n    , trackingcontext\n    , approver\n    , approval_context_rnk\n    , approvaldatetime_nzt\n    , documentnum\n    , submitter\n    , createdby\n    , costcentreowner\n    , costcentrevalue\n    , costcentrename\n    , costcentreownerapprovalamount\n    , budgetcontrol\n    , workflowstatus\n    , workflowstatus_line\n    , purchid\n    , purch_recid\n    , purchline_recid\n    , purchreqid\n    , purchreq_recid\n    , purchreqline_recid\n    , dataareaid\n    , approval_rnk\nfrom ct\nwhere approval_rnk = 1", "relation_name": "\"dwh_sanford\".\"stage\".\"stg_dim_d365_workflowapproval_1\""}], "elapsed_time": 35.94319033622742, "args": {"log_format_file": "debug", "static_parser": true, "indirect_selection": "eager", "vars": {}, "write_json": true, "project_dir": "d:\\code\\sandbt\\dags\\fabric_d365", "version_check": true, "invocation_command": "dbt ", "log_level": "info", "enable_legacy_logger": false, "quiet": false, "partial_parse_file_diff": true, "send_anonymous_usage_stats": true, "select": ["stg_dim_d365_workflowapproval_1"], "populate_cache": true, "cache_selected_only": false, "require_resource_names_without_spaces": false, "source_freshness_run_project_hooks": false, "warn_error_options": {"include": [], "exclude": []}, "macro_debugging": false, "log_level_file": "debug", "print": true, "defer": false, "show_resource_report": false, "printer_width": 80, "favor_state": false, "profiles_dir": "d:\\code\\sandbt\\dags\\fabric_d365", "exclude": [], "partial_parse": true, "require_explicit_package_overrides_for_builtin_materializations": true, "log_format": "default", "log_path": "d:\\code\\sandbt\\dags\\fabric_d365\\logs", "introspect": true, "use_colors": true, "empty": false, "use_colors_file": true, "strict_mode": false, "log_file_max_bytes": 10485760, "which": "run"}}